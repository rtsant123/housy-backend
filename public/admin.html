<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housie Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 8px; }
        .tab { padding: 12px 24px; cursor: pointer; border-radius: 6px; transition: all 0.3s; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: #667eea; color: white; }
        .section { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; }
        .stat-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; }
        .stat-card .value { font-size: 36px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .login-container h2 { margin-bottom: 30px; text-align: center; }
        #loginSection { display: block; }
        #adminPanel { display: none; }
        .status-pending { color: #f59e0b; font-weight: 600; }
        .status-completed { color: #10b981; font-weight: 600; }
        .status-failed { color: #ef4444; font-weight: 600; }
    </style>
</head>
<body>
    <div id="loginSection">
        <div class="login-container">
            <h2>üéØ Housie Admin Login</h2>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" id="loginPhone" placeholder="10-digit phone number">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 15px;" id="loginBtn">Login</button>
            <p style="margin-top: 20px; text-align: center; color: #666; font-size: 14px;">Default: 9876543210 / admin123</p>
        </div>
    </div>

    <div id="adminPanel">
        <div class="header">
            <h1>üéØ Housie Admin Panel</h1>
            <p>Manage games, payments, and users</p>
        </div>

        <div class="container">
            <div class="tabs">
                <div class="tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
                <div class="tab" onclick="showTab('payments')">üí∞ Pending Payments</div>
                <div class="tab" onclick="showTab('games')">üéÆ Create Game</div>
                <div class="tab" onclick="showTab('winners')">üèÜ Declare Winner</div>
                <div class="tab" onclick="showTab('users')">üë• Users</div>
            </div>

            <div id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="stats" id="statsContainer">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Games</h3>
                        <div class="value" id="totalGames">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Payments</h3>
                        <div class="value" id="pendingPayments">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" id="totalRevenue">‚Çπ0</div>
                    </div>
                </div>
            </div>

            <div id="payments" class="section">
                <h2>Pending Payments</h2>
                <table id="paymentsTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Phone</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsBody"></tbody>
                </table>
            </div>

            <div id="games" class="section">
                <h2>Create New Game</h2>
                <div class="form-group">
                    <label>Game Title</label>
                    <input type="text" id="gameTitle" placeholder="e.g., Weekend Special">
                </div>
                <div class="form-group">
                    <label>Scheduled Time</label>
                    <input type="datetime-local" id="gameTime">
                </div>
                <div class="form-group">
                    <label>Entry Fee (‚Çπ)</label>
                    <input type="number" id="entryFee" placeholder="50">
                </div>
                <div class="form-group">
                    <label>Prize Pool (‚Çπ)</label>
                    <input type="number" id="prizePool" placeholder="5000">
                </div>
                <div class="form-group">
                    <label>Max Players</label>
                    <input type="number" id="maxSpots" placeholder="100">
                </div>
                <button class="btn btn-primary" onclick="createGame()">Create Game</button>
            </div>

            <div id="winners" class="section">
                <h2>Declare Winner</h2>
                <div class="form-group">
                    <label>Select Game</label>
                    <select id="winnerGameId"></select>
                </div>
                <div class="form-group">
                    <label>Ticket ID</label>
                    <input type="text" id="winnerTicketId" placeholder="Enter ticket ID">
                </div>
                <div class="form-group">
                    <label>Winning Pattern</label>
                    <select id="winningPattern">
                        <option>Early Five</option>
                        <option>Top Line</option>
                        <option>Middle Line</option>
                        <option>Bottom Line</option>
                        <option>Full House</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Win Amount (‚Çπ)</label>
                    <input type="number" id="winAmount" placeholder="1000">
                </div>
                <button class="btn btn-success" onclick="declareWinner()">Declare Winner</button>
            </div>

            <div id="users" class="section">
                <h2>All Users</h2>
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Wallet Balance</th>
                            <th>KYC Status</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://housy-backend-production.up.railway.app/api';
        let token = localStorage.getItem('adminToken');

        async function login(e) {
            if (e) e.preventDefault();

            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;

            console.log('=== LOGIN ATTEMPT ===');
            console.log('Phone:', phone);
            console.log('Password length:', password ? password.length : 0);
            console.log('API URL:', `${API_URL}/auth/login`);

            // Validate inputs
            if (!phone || !password) {
                alert('‚ùå Please enter both phone number and password');
                return;
            }

            // Show loading
            const btn = document.getElementById('loginBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Logging in...';
            btn.disabled = true;

            try {
                const requestBody = { phone, password };
                console.log('Request body:', requestBody);

                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', res.status);
                console.log('Response headers:', res.headers);

                const data = await res.json();
                console.log('Full response:', data);

                if (res.ok && data.success && data.data && data.data.token) {
                    console.log('‚úÖ Login successful!');

                    // Check if user is admin
                    if (data.data.user.role !== 'admin') {
                        alert('‚ùå Access denied. Admin account required.');
                        btn.textContent = originalText;
                        btn.disabled = false;
                        return;
                    }

                    token = data.data.token;
                    localStorage.setItem('adminToken', token);
                    localStorage.setItem('adminUser', JSON.stringify(data.data.user));

                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';

                    alert('‚úÖ Login successful! Welcome ' + data.data.user.name);
                    loadDashboard();
                } else {
                    console.error('‚ùå Login failed:', data);
                    alert('‚ùå Login failed: ' + (data.message || 'Invalid credentials'));
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                alert('‚ùå Network error: ' + error.message + '\n\nPlease check:\n1. Internet connection\n2. Backend server status\n3. Browser console (F12)');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Setup event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Login button click
            document.getElementById('loginBtn').addEventListener('click', login);

            // Enter key on password field
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login(e);
                }
            });

            // Enter key on phone field
            document.getElementById('loginPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login(e);
                }
            });
        });

        async function loadDashboard() {
            console.log('üìä Loading dashboard...');
            try {
                const res = await fetch(`${API_URL}/admin/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                console.log('Dashboard data:', data);

                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.data.totalUsers || 0;
                    document.getElementById('totalGames').textContent = data.data.totalGames || 0;
                    document.getElementById('pendingPayments').textContent = data.data.pendingPayments || 0;
                    document.getElementById('totalRevenue').textContent = '‚Çπ' + (data.data.totalRevenue || 0).toLocaleString();
                    console.log('‚úÖ Dashboard loaded successfully');
                } else {
                    console.error('‚ùå Dashboard API failed:', data);
                    alert('Failed to load dashboard: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå Error loading dashboard:', error);
                alert('Dashboard error: ' + error.message);
            }

            // Load other data
            await loadPayments();
            await loadGames();
            await loadUsers();
        }

        async function loadPayments() {
            try {
                const res = await fetch(`${API_URL}/admin/payments/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const tbody = document.getElementById('paymentsBody');
                tbody.innerHTML = data.data.map(p => `
                    <tr>
                        <td>${p.userId.name}</td>
                        <td>${p.userId.phone}</td>
                        <td>‚Çπ${p.amount}</td>
                        <td>${p.paymentMethod || '-'}</td>
                        <td>${p.transactionId || '-'}</td>
                        <td class="status-${p.status}">${p.status}</td>
                        <td>
                            <button class="btn btn-success" onclick="approvePayment('${p._id}')">Approve</button>
                            <button class="btn btn-danger" onclick="rejectPayment('${p._id}')">Reject</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        async function approvePayment(id) {
            try {
                const res = await fetch(`${API_URL}/admin/payments/${id}/approve`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(data.message);
                loadPayments();
                loadDashboard();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rejectPayment(id) {
            try {
                const res = await fetch(`${API_URL}/admin/payments/${id}/reject`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(data.message);
                loadPayments();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function createGame() {
            const game = {
                title: document.getElementById('gameTitle').value,
                scheduledTime: new Date(document.getElementById('gameTime').value).toISOString(),
                entryFee: parseInt(document.getElementById('entryFee').value),
                prizePool: parseInt(document.getElementById('prizePool').value),
                maxSpots: parseInt(document.getElementById('maxSpots').value),
                deadline: new Date(document.getElementById('gameTime').value).toISOString()
            };

            try {
                const res = await fetch(`${API_URL}/admin/games`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(game)
                });
                const data = await res.json();
                alert(data.message);
                loadGames();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadGames() {
            try {
                const res = await fetch(`${API_URL}/games`);
                const data = await res.json();

                const select = document.getElementById('winnerGameId');
                select.innerHTML = data.data.map(g =>
                    `<option value="${g._id}">${g.title} - ${new Date(g.scheduledTime).toLocaleString()}</option>`
                ).join('');
            } catch (error) {
                console.error('Error loading games:', error);
            }
        }

        async function declareWinner() {
            const winnerData = {
                gameId: document.getElementById('winnerGameId').value,
                winnerTicketId: document.getElementById('winnerTicketId').value,
                winningPattern: document.getElementById('winningPattern').value,
                winAmount: parseInt(document.getElementById('winAmount').value)
            };

            try {
                const res = await fetch(`${API_URL}/admin/declare-winner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(winnerData)
                });
                const data = await res.json();
                alert(data.message);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const tbody = document.getElementById('usersBody');
                tbody.innerHTML = data.data.map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.phone}</td>
                        <td>‚Çπ${u.walletBalance}</td>
                        <td>${u.kycStatus}</td>
                        <td>${u.isActive ? 'Active' : 'Inactive'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        if (token) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadDashboard();
        }
    </script>
</body>
</html>
